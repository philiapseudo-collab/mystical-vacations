generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Order {
  id                     String   @id
  amount                 Float
  currency               String   @default("KES")
  status                 String   @default("PENDING")
  pesapalOrderTrackingId String?  @unique
  customerEmail          String
  customerPhone          String?
  description            String?
  reference              String
  createdAt              DateTime @default(now())
}

model Booking {
  id               String    @id @default(uuid())
  bookingReference String    @unique
  items            Json      // Store IBookingItem[] as JSON
  guestDetails     Json      // Store guest details as JSON
  priceBreakdown   Json      // Store IPriceBreakdown as JSON
  status           String    @default("pending")
  paymentStatus    String    @default("pending")
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  payments         Payment[]

  @@index([bookingReference])
  @@map("bookings")
}

model Payment {
  id               String   @id @default(uuid())
  bookingId        String
  booking          Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  amount           Float
  currency         String   @default("KES")
  status           String   @default("PENDING") // PENDING, COMPLETED, FAILED
  provider         String   @default("PESAPAL")
  trackingId       String?  @unique
  merchantReference String
  paymentMethod    String?  // e.g., "MPESA", "VISA"
  paymentAccount   String?  // The phone number/masked card used
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([bookingId])
  @@index([trackingId])
  @@index([merchantReference])
  @@map("payments")
}

model SGRTicket {
  id               String   @id @default(uuid())
  ticketNumber     String   @unique
  route            String
  trainNumber      String
  class            String
  seatNumber       String
  departureTime    String   // ISO 8601 format: "2025-01-15T08:00:00.000Z"
  arrivalTime      String   // ISO 8601 format: "2025-01-15T13:30:00.000Z"
  passengerName    String
  qrCode           String
  bookingReference String
  createdAt        DateTime @default(now())

  @@index([ticketNumber])
  @@index([bookingReference])
  @@map("sgr_tickets")
}
